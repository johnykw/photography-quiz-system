<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>攝影技能評估問卷 - 找到最適合您的攝影課程</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
            text-align: center;
        }

        .camera-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .feature {
            text-align: center;
        }

        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .feature h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .feature p {
            color: #666;
            font-size: 0.95em;
        }

        .buttons {
            display: flex;
            justify-content: center;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
        }

        .btn-tertiary {
            background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* 問卷樣式 */
        .quiz-container {
            display: none;
            text-align: left;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            transition: width 0.3s ease;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .question-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .option:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        .option-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: 700;
            font-size: 0.95em;
            transition: all 0.3s ease;
        }

        .option.selected .option-number {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .option span {
            font-weight: 500;
            font-size: 1.05em;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-btn {
            padding: 18px 36px;
            border: none;
            border-radius: 12px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.prev {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .nav-btn.prev:hover:not(:disabled) {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .nav-btn.next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .nav-btn.next:hover:not(:disabled) {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        /* 結果頁面樣式 */
        .result-container {
            display: none;
            text-align: center;
        }

        .score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
        }

        .level-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            margin-bottom: 30px;
            color: white;
        }

        .courses {
            text-align: left;
            margin-top: 30px;
        }

        .course-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
        }

        .course-summary p {
            margin: 8px 0;
            font-size: 1.1em;
        }

        .course-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            display: flex;
            align-items: flex-start;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .course-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin-right: 15px;
            min-width: 25px;
        }

        .course-content {
            flex: 1;
        }

        .course-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .course-meta {
            margin-bottom: 10px;
        }

        .course-category, .course-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin-right: 8px;
        }

        .course-category {
            background: #e3f2fd;
            color: #1976d2;
        }

        .course-level {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .course-description {
            color: #666;
            font-size: 0.95em;
            line-height: 1.5;
        }

        /* 管理員登錄樣式 */
        .admin-login {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 90%;
            text-align: center;
            margin: 0 auto;
        }
        
        .admin-login h2 {
            color: #333;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* 管理員介面樣式 */
        .admin-panel {
            display: none;
            text-align: left;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-size: 1.5em;
            font-weight: 600;
        }

        .admin-welcome {
            font-size: 1em;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .admin-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .menu-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .menu-item.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .admin-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            border: 2px solid #e0e0e0;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        /* 詳細統計樣式 */
        .filter-section, .data-management-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .data-management-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
        }

        .filter-section label, .data-management-section label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        .filter-section input, .data-management-section input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .filter-btn {
            background: #4CAF50 !important;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .clear-filter-btn {
            background: #2196F3 !important;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .clear-data-btn {
            background: #F44336 !important;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .clear-all-btn {
            background: #FF9800 !important;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .question-stat {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .question-stat h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .correct-rate {
            margin-bottom: 15px;
        }

        .correct-rate-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .correct-rate-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .option-stats h5 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .option-item:last-child {
            border-bottom: none;
        }

        .option-text {
            flex: 1;
            color: #333;
        }

        .option-percentage {
            color: #666;
            font-weight: 600;
            margin-left: 10px;
        }

        .bar-chart {
            width: 100px;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-left: 10px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: #667eea;
            transition: width 0.3s ease;
        }

        .score-distribution {
            margin-top: 30px;
        }

        .score-distribution h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .score-item:last-child {
            border-bottom: none;
        }

        .score-label {
            font-weight: 600;
            color: #333;
        }

        .score-bar {
            width: 200px;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            margin: 0 15px;
            overflow: hidden;
        }

        .score-bar-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }

        .score-percentage {
            color: #666;
            font-weight: 600;
            min-width: 50px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }

            .features {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .buttons {
                grid-template-columns: 1fr;
            }

            .admin-menu {
                grid-template-columns: 1fr;
            }

            .filter-section, .data-management-section {
                grid-template-columns: 1fr;
            }

            .score-bar {
                width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 首頁 -->
        <div id="home" class="home-page">
            <div class="camera-icon">📷</div>
            <h1>攝影技能評估問卷</h1>
            <p class="subtitle">找到最適合您的攝影課程</p>
            
            <div class="features">
                <div class="feature">
                    <div class="feature-icon">⏰</div>
                    <h3>預計時間</h3>
                    <p>5-8分鐘</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">📚</div>
                    <h3>專業評估</h3>
                    <p>19道精選問題</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">💝</div>
                    <h3>個人化推薦</h3>
                    <p>量身定制課程</p>
                </div>
            </div>
            
            <div class="buttons">
                <button class="btn btn-primary" onclick="startQuiz()">開始評估 ✨</button>
            </div>
        </div>

        <!-- 問卷頁面 -->
        <div id="quiz" class="quiz-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div id="question-info" class="question-info"></div>
            <div id="question-container"></div>
            <div class="navigation">
                <button class="nav-btn prev" id="prev-btn" onclick="previousQuestion()" disabled>← 上一題</button>
                <button class="nav-btn next" id="next-btn" onclick="nextQuestion()">下一題 →</button>
            </div>
        </div>

        <!-- 結果頁面 -->
        <div id="result" class="result-container">
            <h2>您的攝影技能評估結果</h2>
            <div id="score-display"></div>
            <div id="level-display"></div>
            <div id="courses-display"></div>
            <button class="btn btn-primary" onclick="restartQuiz()" style="margin-top: 30px;">重新開始</button>
        </div>

        <!-- 管理員登錄 -->
        <div id="admin-login" class="admin-login">
            <h2>管理員登錄</h2>
            <div class="form-group">
                <label>用戶名</label>
                <input type="text" id="admin-username" placeholder="請輸入用戶名">
            </div>
            <div class="form-group">
                <label>密碼</label>
                <input type="password" id="admin-password" placeholder="請輸入密碼">
            </div>
            <div class="buttons">
                <button class="btn btn-primary" onclick="adminLogin()">登錄</button>
                <button class="btn btn-secondary" onclick="showHome()">返回首頁</button>
            </div>
        </div>

        <!-- 管理員面板 -->
        <div id="admin-panel" class="admin-panel">
            <div class="admin-header">
                <div>
                    <div class="admin-title">攝影問卷管理系統</div>
                    <div class="admin-welcome">歡迎，管理員</div>
                </div>
                <button class="logout-btn" onclick="adminLogout()">登出</button>
            </div>

            <div class="admin-menu">
                <div class="menu-item active" onclick="showAdminSection('dashboard')">儀表板</div>
                <div class="menu-item" onclick="showAdminSection('questions')">問題管理</div>
                <div class="menu-item" onclick="showAdminSection('courses')">課程管理</div>
                <div class="menu-item" onclick="showAdminSection('score-settings')">評分設定</div>
                <div class="menu-item" onclick="showAdminSection('responses')">即時查看回應</div>
                <div class="menu-item" onclick="showAdminSection('users')">用戶資料</div>
                <div class="menu-item" onclick="showAdminSection('detailed-stats')">詳細統計</div>
                <div class="menu-item" onclick="showAdminSection('export')">數據導出</div>
            </div>

            <!-- 儀表板 -->
            <div id="dashboard" class="admin-content">
                <h3>系統統計概覽</h3>
                <div class="stats-overview" id="stats-overview">
                    <!-- 統計數據將在這裡動態載入 -->
                </div>
            </div>

            <!-- 詳細統計 -->
            <div id="detailed-stats" class="admin-content" style="display: none;">
                <h3>詳細統計</h3>
                
                <!-- 數據篩選區塊 -->
                <div class="filter-section">
                    <div>
                        <label>開始日期：</label>
                        <input type="date" id="start-date">
                    </div>
                    <div>
                        <label>結束日期：</label>
                        <input type="date" id="end-date">
                    </div>
                    <div>
                        <button onclick="filterData()" class="filter-btn">篩選</button>
                    </div>
                    <div>
                        <button onclick="clearFilter()" class="clear-filter-btn">清除篩選</button>
                    </div>
                </div>
                
                <!-- 數據管理區塊 -->
                <div class="data-management-section">
                    <h4 style="grid-column: 1 / -1; margin: 0 0 15px 0;">數據管理</h4>
                    <div>
                        <label>清除開始日期：</label>
                        <input type="date" id="clear-start-date">
                    </div>
                    <div>
                        <label>清除結束日期：</label>
                        <input type="date" id="clear-end-date">
                    </div>
                    <div>
                        <button onclick="clearDataByDate()" class="clear-data-btn">清除數據</button>
                    </div>
                    <div>
                        <button onclick="clearAllData()" class="clear-all-btn">清除所有數據</button>
                    </div>
                </div>
                
                <div id="stats-content">
                    <div id="total-responses"></div>
                    <div id="question-stats"></div>
                    <div id="score-distribution"></div>
                </div>
            </div>

            <!-- 其他管理功能 -->
            <div id="questions" class="admin-content" style="display: none;">
                <h3>問題管理</h3>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddQuestionModal()">添加新問題</button>
                </div>
                
                <div id="questions-list">
                    <!-- 問題列表將在這裡動態載入 -->
                </div>
                
                <!-- 添加/編輯問題模態框 -->
                <div id="question-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h4 id="question-modal-title">添加新問題</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label>問題內容：</label>
                            <textarea id="question-content" style="width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>問題類型：</label>
                            <select id="question-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="single">單選題</option>
                                <option value="multiple">多選題</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>選項：</label>
                            <div id="question-options">
                                <!-- 選項將在這裡動態添加 -->
                            </div>
                            <button type="button" onclick="addQuestionOption()" style="margin-top: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px;">添加選項</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>正確答案：</label>
                            <div id="correct-answer-section">
                                <!-- 正確答案選擇將在這裡顯示 -->
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" onclick="closeQuestionModal()" style="margin-right: 10px; padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 5px;">取消</button>
                            <button type="button" onclick="saveQuestion()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px;">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="courses" class="admin-content" style="display: none;">
                <h3>課程管理</h3>
                
                <!-- 課程管理主要選項 -->
                <div style="display: flex; gap: 15px; margin-bottom: 25px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showAddCourseModal()" style="background: #28a745; border-color: #28a745;">
                        ➕ 增加課程
                    </button>
                    <button class="btn btn-primary" onclick="showEditCourseSelection()" style="background: #007bff; border-color: #007bff;">
                        ✏️ 編輯課程
                    </button>
                    <button class="btn btn-primary" onclick="showDeleteCourseSelection()" style="background: #dc3545; border-color: #dc3545;">
                        🗑️ 刪除課程
                    </button>
                    <button class="btn btn-primary" onclick="showRecommendationSettings()" style="background: #6f42c1; border-color: #6f42c1;">
                        📊 推介課程數量
                    </button>
                </div>
                
                <!-- 課程管理內容區域 -->
                <div id="course-management-content">
                    <!-- 預設顯示課程列表 -->
                    <div id="courses-list-view">
                        <h4 style="margin-bottom: 15px; color: #333;">📚 課程總覽</h4>
                        <div id="courses-list">
                            <!-- 課程列表將在這裡動態載入 -->
                        </div>
                    </div>
                    
                    <!-- 編輯課程選擇界面 -->
                    <div id="edit-course-selection" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #333;">✏️ 選擇要編輯的課程</h4>
                        <div id="edit-courses-list">
                            <!-- 可編輯課程列表將在這裡動態載入 -->
                        </div>
                        <button onclick="showCoursesListView()" style="margin-top: 15px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px;">
                            ← 返回課程總覽
                        </button>
                    </div>
                    
                    <!-- 刪除課程選擇界面 -->
                    <div id="delete-course-selection" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #333;">🗑️ 選擇要刪除的課程</h4>
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                ⚠️ <strong>注意：</strong>刪除課程後將無法恢復，請謹慎操作。
                            </p>
                        </div>
                        <div id="delete-courses-list">
                            <!-- 可刪除課程列表將在這裡動態載入 -->
                        </div>
                        <button onclick="showCoursesListView()" style="margin-top: 15px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px;">
                            ← 返回課程總覽
                        </button>
                    </div>
                    
                    <!-- 推介課程數量設定 -->
                    <div id="recommendation-settings" style="display: none;">
                        <h4 style="margin-bottom: 15px; color: #333;">📊 推介課程數量設定</h4>
                        <div style="background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <p style="margin: 0; color: #0056b3; font-size: 14px;">
                                💡 <strong>說明：</strong>設定參與者完成問卷後系統推薦的課程數量範圍（0-100個課程）。
                            </p>
                        </div>
                        
                        <!-- 當前啟用設定 -->
                        <div id="current-recommendation-setting" style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <!-- 當前設定將在這裡顯示 -->
                        </div>
                        
                        <!-- 所有設定列表 -->
                        <div id="recommendation-settings-list">
                            <!-- 設定列表將在這裡動態載入 -->
                        </div>
                        
                        <!-- 操作按鈕 -->
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="showAddRecommendationSettingModal()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px;">
                                ➕ 新增設定
                            </button>
                            <button onclick="showCoursesListView()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px;">
                                ← 返回課程總覽
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 添加/編輯課程模態框 -->
                <div id="course-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <h4 id="course-modal-title">添加新課程</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <label>課程標題：</label>
                            <input type="text" id="course-title" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>課程描述：</label>
                            <textarea id="course-description" style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>課程分類：</label>
                            <select id="course-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="新手入門">新手入門</option>
                                <option value="初階攝影">初階攝影</option>
                                <option value="進階攝影">進階攝影</option>
                                <option value="專業技術">專業技術</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label>適合程度：</label>
                            <select id="course-level" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="攝影新手">攝影新手</option>
                                <option value="中階攝影師">中階攝影師</option>
                                <option value="進階攝影師">進階攝影師</option>
                                <option value="所有程度">所有程度</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="course-active" checked style="transform: scale(1.2);">
                                <span>課程開啟（取消勾選則關閉課程，不會在推薦中顯示）</span>
                            </label>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label>興趣關聯（選擇此課程適合的攝影題材）：</label>
                            <div id="interest-tags-container" style="margin-top: 10px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 15px; background: #f9f9f9;">
                                <!-- 興趣標籤選項將在這裡動態載入 -->
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" onclick="closeCourseModal()" style="margin-right: 10px; padding: 10px 20px; background: #ccc; color: #333; border: none; border-radius: 5px;">取消</button>
                            <button type="button" onclick="saveCourse()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px;">保存</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 評分設定 -->
            <div id="score-settings" class="admin-content" style="display: none;">
                <h3>評分設定</h3>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4>攝影師等級分數設定</h4>
                        <button onclick="refreshScoreSettings()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🔄 刷新設定
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p style="margin: 0; color: #666; font-size: 14px;">
                            <strong>說明：</strong>您可以自訂各等級攝影師的分數範圍。分數範圍不能重疊，系統會根據參與者的分數自動分配等級並推薦相應課程。
                        </p>
                    </div>
                    
                    <div id="score-settings-list">
                        <!-- 評分設定列表將在這裡動態載入 -->
                        <p style="text-align: center; color: #666; padding: 40px;">載入中...</p>
                    </div>
                </div>
            </div>

            <!-- 推介課程數量設定模態框 -->
            <div id="recommendation-setting-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h4 id="recommendation-setting-modal-title">新增推介課程數量設定</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label>設定名稱：</label>
                        <input type="text" id="recommendation-setting-name" placeholder="例如：標準推薦、精選推薦" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>最少課程數量（0-100）：</label>
                        <input type="number" id="recommendation-min-courses" min="0" max="100" value="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>最多課程數量（0-100）：</label>
                        <input type="number" id="recommendation-max-courses" min="0" max="100" value="8" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>設定描述：</label>
                        <textarea id="recommendation-setting-description" placeholder="描述這個推薦設定的用途..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="recommendation-setting-active" checked>
                            啟用此設定
                        </label>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" onclick="closeRecommendationSettingModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; margin-right: 10px;">取消</button>
                        <button type="button" onclick="saveRecommendationSetting()" style="padding: 10px 20px; background: #6f42c1; color: white; border: none; border-radius: 5px;">保存</button>
                    </div>
                </div>
            </div>

            <!-- 評分設定模態框 -->
            <div id="score-setting-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
                    <h4 id="score-setting-modal-title">編輯評分設定</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label>等級名稱：</label>
                        <input type="text" id="score-setting-level-name" placeholder="例如：攝影新手、進階攝影師" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>最低分數（0-100）：</label>
                        <input type="number" id="score-setting-min-score" min="0" max="100" value="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>最高分數（0-100）：</label>
                        <input type="number" id="score-setting-max-score" min="0" max="100" value="10" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>等級描述：</label>
                        <textarea id="score-setting-description" placeholder="描述這個等級的特點和適合的課程..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="score-setting-active" checked>
                            啟用此等級
                        </label>
                    </div>
                    
                    <div style="text-align: right; margin-top: 20px;">
                        <button type="button" onclick="closeScoreSettingModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; margin-right: 10px;">取消</button>
                        <button type="button" onclick="saveScoreSetting()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px;">保存</button>
                    </div>
                </div>
            </div>

            <div id="responses" class="admin-content" style="display: none;">
                <h3>即時查看回應</h3>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4>實時統計</h4>
                        <button onclick="refreshRealTimeStats()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            🔄 刷新數據
                        </button>
                    </div>
                    
                    <div id="real-time-stats-content">
                        <p style="text-align: center; color: #666; padding: 40px;">載入中...</p>
                    </div>
                </div>
            </div>

            <div id="users" class="admin-content" style="display: none;">
                <h3>用戶資料</h3>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 20px;">管理員資料</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <label>用戶名：</label>
                        <input type="text" id="admin-profile-username" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>新密碼：</label>
                        <input type="password" id="admin-profile-password" placeholder="留空則不修改密碼" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label>確認新密碼：</label>
                        <input type="password" id="admin-profile-password-confirm" placeholder="留空則不修改密碼" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    
                    <div style="text-align: right;">
                        <button type="button" onclick="updateAdminProfile()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px;">更新資料</button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                    <h4 style="margin-bottom: 15px;">帳戶信息</h4>
                    <div id="admin-profile-info">
                        <!-- 管理員資料將在這裡顯示 -->
                    </div>
                </div>
            </div>

            <div id="export" class="admin-content" style="display: none;">
                <h3>數據導出</h3>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 20px;">篩選條件</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">開始日期：</label>
                            <input type="datetime-local" id="export-start-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">結束日期：</label>
                            <input type="datetime-local" id="export-end-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="clearExportDates()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; margin-right: 10px;">清除日期</button>
                        <button onclick="setTodayRange()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; margin-right: 10px;">今天</button>
                        <button onclick="setWeekRange()" style="padding: 8px 16px; background: #17a2b8; color: white; border: none; border-radius: 5px; margin-right: 10px;">本週</button>
                        <button onclick="setMonthRange()" style="padding: 8px 16px; background: #ffc107; color: black; border: none; border-radius: 5px;">本月</button>
                    </div>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h4 style="margin-bottom: 20px;">數據清除</h4>
                    
                    <div style="margin-bottom: 15px;">
                        <button onclick="clearFilteredData()" style="padding: 10px 20px; background: #fd7e14; color: white; border: none; border-radius: 5px; margin-right: 10px;">清除篩選範圍內的資料</button>
                        <button onclick="clearAllData()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px;">清除所有資料</button>
                    </div>
                    
                    <p style="color: #6c757d; font-size: 14px; margin: 0;">
                        ⚠️ 注意：數據清除操作無法撤銷，請謹慎操作
                    </p>
                </div>
                
                <div style="background: white; padding: 25px; border-radius: 15px;">
                    <h4 style="margin-bottom: 20px;">數據導出</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div style="text-align: center; padding: 20px; border: 2px dashed #28a745; border-radius: 10px;">
                            <div style="font-size: 48px; color: #28a745; margin-bottom: 10px;">📊</div>
                            <h5 style="margin-bottom: 10px;">Excel 格式</h5>
                            <p style="color: #6c757d; margin-bottom: 15px;">導出詳細的統計數據表格</p>
                            <button onclick="exportExcel()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; width: 100%;">
                                <span id="excel-loading" style="display: none;">導出中...</span>
                                <span id="excel-text">導出 Excel</span>
                            </button>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; border: 2px dashed #fd7e14; border-radius: 10px;">
                            <div style="font-size: 48px; color: #fd7e14; margin-bottom: 10px;">📈</div>
                            <h5 style="margin-bottom: 10px;">PowerPoint 格式</h5>
                            <p style="color: #6c757d; margin-bottom: 15px;">導出圖像化統計報告</p>
                            <button onclick="exportPowerPoint()" style="padding: 10px 20px; background: #fd7e14; color: white; border: none; border-radius: 5px; width: 100%;">
                                <span id="ppt-loading" style="display: none;">導出中...</span>
                                <span id="ppt-text">導出 PowerPoint</span>
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                        <h6 style="margin-bottom: 10px;">導出說明：</h6>
                        <ul style="margin: 0; padding-left: 20px; color: #6c757d;">
                            <li>Excel格式包含詳細的問題統計、選項分析和回應數據</li>
                            <li>PowerPoint格式包含圖表化的統計報告和視覺化分析</li>
                            <li>可以根據日期範圍篩選要導出的數據</li>
                            <li>導出的文件會自動下載到您的設備</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let questions = [];
        let currentQuestion = 0;
        let answers = [];
        let isTestMode = false;

        // 頁面顯示函數
        function showPage(pageId) {
            console.log('showPage調用，目標頁面:', pageId);
            
            // 隱藏所有頁面
            const pages = ['home', 'quiz', 'result', 'admin-login', 'admin-panel'];
            pages.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.display = 'none';
                    console.log('隱藏頁面:', id);
                } else {
                    console.log('找不到頁面元素:', id);
                }
            });
            
            // 顯示目標頁面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.style.display = 'block';
                console.log('顯示頁面:', pageId);
            } else {
                console.error('找不到目標頁面:', pageId);
            }
        }

        function showHome() {
            showPage('home');
        }

        function showAdminLogin() {
            showPage('admin-login');
        }

        // 載入問題
        async function loadQuestions() {
            try {
                console.log('開始載入問題...');
                const response = await fetch('/api/questions');
                console.log('API響應狀態:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('載入的問題數據:', data);
                console.log('問題數量:', data.length);
                
                // 確保正確賦值給全局變量
                questions = data;
                console.log('賦值後的questions長度:', questions.length);
                console.log('全局questions變量:', questions);
                
                return data;
            } catch (error) {
                console.error('載入問題失敗:', error);
                alert('載入問題失敗，請重新整理頁面');
                throw error;
            }
        }

        // 開始問卷
        async function startQuiz() {
            console.log('開始問卷...');
            isTestMode = false;
            
            try {
                await loadQuestions();
                console.log('載入完成，questions長度:', questions.length);
                
                if (!questions || questions.length === 0) {
                    console.error('沒有可用的問題');
                    alert('沒有可用的問題');
                    return;
                }
                
                currentQuestion = 0;
                answers = [];
                console.log('切換到問卷頁面...');
                showPage('quiz');
                console.log('顯示第一題...');
                displayQuestion();
            } catch (error) {
                console.error('開始問卷失敗:', error);
                alert('開始問卷失敗，請重試');
            }
        }

        // 測試模式
        async function startTestMode() {
            console.log('開始測試模式...');
            isTestMode = true;
            
            try {
                await loadQuestions();
                console.log('測試模式載入完成，questions長度:', questions.length);
                
                if (!questions || questions.length === 0) {
                    console.error('沒有可用的問題');
                    alert('沒有可用的問題');
                    return;
                }
                
                // 初始化答案數組
                answers = new Array(questions.length).fill(null);
                
                // 快速自動答題前17題
                console.log('快速自動答題前17題...');
                for (let i = 0; i < Math.min(17, questions.length); i++) {
                    const question = questions[i];
                    let answer;
                    
                    if (question.question_type === 'multiple') {
                        // 多選題隨機選擇1-3個選項
                        const numSelections = Math.floor(Math.random() * 3) + 1;
                        answer = [];
                        for (let j = 0; j < numSelections; j++) {
                            const randomOption = Math.floor(Math.random() * question.options.length);
                            if (!answer.includes(randomOption)) {
                                answer.push(randomOption);
                            }
                        }
                    } else {
                        // 單選題隨機選擇一個選項
                        answer = Math.floor(Math.random() * question.options.length);
                    }
                    
                    answers[i] = answer;
                    console.log(`第${i+1}題自動答題完成:`, answer);
                }
                
                // 跳到第18題讓用戶手動選擇
                currentQuestion = Math.min(17, questions.length - 1); // 第18題的索引是17
                console.log('切換到問卷頁面...');
                showPage('quiz');
                console.log(`跳到第${currentQuestion + 1}題，讓用戶手動選擇...`);
                displayQuestion();
                
                // 顯示測試模式提示
                alert(`🚀 測試模式已啟動！\n\n已自動完成前${Math.min(17, questions.length)}題\n現在請手動完成剩餘題目`);
                
            } catch (error) {
                console.error('開始測試模式失敗:', error);
                alert('開始測試模式失敗，請重試');
            }
        }

        // 自動答題功能
        function autoAnswerQuestions() {
            const interval = setInterval(() => {
                const question = questions[currentQuestion];
                let answer;
                
                if (question.question_type === 'multiple') {
                    // 多選題隨機選擇1-3個選項
                    const numSelections = Math.floor(Math.random() * 3) + 1;
                    answer = [];
                    for (let i = 0; i < numSelections; i++) {
                        const randomOption = Math.floor(Math.random() * question.options.length);
                        if (!answer.includes(randomOption)) {
                            answer.push(randomOption);
                        }
                    }
                } else {
                    // 單選題隨機選擇一個選項
                    answer = Math.floor(Math.random() * question.options.length);
                }
                
                answers[currentQuestion] = answer;
                
                // 更新UI顯示選中狀態
                if (question.question_type === 'multiple') {
                    answer.forEach(optionIndex => {
                        const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
                        if (optionElement) {
                            optionElement.classList.add('selected');
                        }
                    });
                } else {
                    const optionElement = document.querySelector(`[data-option="${answer}"]`);
                    if (optionElement) {
                        optionElement.classList.add('selected');
                    }
                }
                
                updateProgress();
                
                setTimeout(() => {
                    if (currentQuestion < questions.length - 1) {
                        currentQuestion++;
                        displayQuestion();
                    } else {
                        clearInterval(interval);
                        submitQuiz();
                    }
                }, 1000);
            }, 1500);
        }

        // 顯示問題
        function displayQuestion() {
            console.log('displayQuestion被調用，currentQuestion:', currentQuestion);
            console.log('questions數組:', questions);
            console.log('questions長度:', questions.length);
            
            if (!questions || questions.length === 0) {
                console.error('沒有可用的問題數據');
                alert('沒有可用的問題數據');
                return;
            }
            
            if (currentQuestion >= questions.length) {
                console.error('問題索引超出範圍');
                return;
            }
            
            const question = questions[currentQuestion];
            console.log('當前問題:', question);
            
            const container = document.getElementById('question-container');
            const info = document.getElementById('question-info');
            
            if (!container || !info) {
                console.error('找不到問題容器元素');
                return;
            }
            
            info.innerHTML = `第 ${currentQuestion + 1} / ${questions.length} 題`;
            
            let optionsHtml = '';
            if (question.question_type === 'multiple') {
                optionsHtml = question.options.map((option, index) => {
                    // 檢查是否是第18題的"其它"選項
                    const isQuestion18 = currentQuestion === 17; // 第18題的索引是17
                    const isOtherOption = option === '其它';
                    
                    if (isQuestion18 && isOtherOption) {
                        return `
                            <div class="option" data-option="${index}" onclick="selectMultipleOption(${index})">
                                <div class="option-number">${index + 1}</div>
                                <span>${option}</span>
                                <input type="text" id="other-input-${index}" placeholder="請輸入其他攝影類型..." 
                                       style="margin-left: 10px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; font-size: 0.9em;"
                                       onclick="event.stopPropagation()" 
                                       onchange="handleOtherInput(${index}, this.value)">
                            </div>
                        `;
                    } else {
                        return `
                            <div class="option" data-option="${index}" onclick="selectMultipleOption(${index})">
                                <div class="option-number">${index + 1}</div>
                                <span>${option}</span>
                            </div>
                        `;
                    }
                }).join('');
            } else {
                optionsHtml = question.options.map((option, index) => `
                    <div class="option" data-option="${index}" onclick="selectOption(${index})">
                        <div class="option-number">${index + 1}</div>
                        <span>${option}</span>
                    </div>
                `).join('');
            }
            
            container.innerHTML = `
                <div class="question-card">
                    <div class="question-title">${question.content}</div>
                    ${question.question_type === 'multiple' ? '<p style="color: #666; margin-bottom: 15px;">（可多選）</p>' : ''}
                    <div class="options">
                        ${optionsHtml}
                    </div>
                </div>
            `;
            
            updateProgress();
            updateNavigation();
            
            // 恢復之前的選擇
            if (answers[currentQuestion] !== undefined && answers[currentQuestion] !== null) {
                if (question.question_type === 'multiple') {
                    if (Array.isArray(answers[currentQuestion])) {
                        answers[currentQuestion].forEach(optionIndex => {
                            const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
                            if (optionElement) {
                                optionElement.classList.add('selected');
                            }
                        });
                    }
                } else {
                    const optionElement = document.querySelector(`[data-option="${answers[currentQuestion]}"]`);
                    if (optionElement) {
                        optionElement.classList.add('selected');
                    }
                }
            }
        }

        // 選擇單選選項
        function selectOption(optionIndex) {
            // 清除之前的選擇
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            
            // 選中當前選項
            const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
            optionElement.classList.add('selected');
            
            answers[currentQuestion] = optionIndex;
            updateNavigation();
        }

        // 選擇多選選項
        function selectMultipleOption(optionIndex) {
            if (!answers[currentQuestion]) {
                answers[currentQuestion] = [];
            }
            
            const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
            const isSelected = optionElement.classList.contains('selected');
            
            if (isSelected) {
                optionElement.classList.remove('selected');
                answers[currentQuestion] = answers[currentQuestion].filter(i => i !== optionIndex);
            } else {
                optionElement.classList.add('selected');
                answers[currentQuestion].push(optionIndex);
            }
            
            updateNavigation();
        }

        // 處理"其它"選項的文字輸入
        function handleOtherInput(optionIndex, inputValue) {
            // 確保answers數組已初始化
            if (!answers[currentQuestion]) {
                answers[currentQuestion] = [];
            }
            
            // 如果有輸入內容，確保該選項被選中
            if (inputValue && inputValue.trim()) {
                const optionElement = document.querySelector(`[data-option="${optionIndex}"]`);
                if (!optionElement.classList.contains('selected')) {
                    optionElement.classList.add('selected');
                    if (!answers[currentQuestion].includes(optionIndex)) {
                        answers[currentQuestion].push(optionIndex);
                    }
                }
                
                // 保存用戶輸入的文字
                if (!window.otherInputs) {
                    window.otherInputs = {};
                }
                window.otherInputs[`q${currentQuestion}_opt${optionIndex}`] = inputValue.trim();
            }
            
            updateNavigation();
        }

        // 更新進度條
        function updateProgress() {
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progress').style.width = progress + '%';
        }

        // 更新導航按鈕
        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentQuestion === 0;
            
            const hasAnswer = answers[currentQuestion] !== undefined && 
                             (Array.isArray(answers[currentQuestion]) ? 
                              answers[currentQuestion].length > 0 : true);
            
            if (currentQuestion === questions.length - 1) {
                nextBtn.textContent = hasAnswer ? '完成評估' : '請選擇答案';
                nextBtn.disabled = !hasAnswer;
            } else {
                nextBtn.textContent = '下一題 →';
                nextBtn.disabled = !hasAnswer;
            }
        }

        // 上一題
        function previousQuestion() {
            if (currentQuestion > 0) {
                currentQuestion--;
                displayQuestion();
            }
        }

        // 下一題
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                displayQuestion();
            } else {
                submitQuiz();
            }
        }

        // 提交問卷
        async function submitQuiz() {
            try {
                // 將answers對象轉換為數組格式
                const answersArray = [];
                for (let i = 0; i < questions.length; i++) {
                    answersArray.push(answers[i]);
                }
                
                const submitData = {
                    answers: answersArray.map((answer, index) => ({
                        question_id: questions[index].id,
                        answer: answer
                    })),
                    // 包含"其它"選項的文字輸入
                    other_inputs: window.otherInputs || {}
                };
                
                console.log('提交數據:', submitData); // 調試用
                
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(submitData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('提交失敗，服務器響應:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                displayResult(result);
            } catch (error) {
                console.error('提交失敗:', error);
                alert('提交失敗，請重試');
            }
        }

        // 顯示結果
        function displayResult(result) {
            showPage('result');
            
            document.getElementById('score-display').innerHTML = `
                <div class="score-circle" style="background: ${result.level_color}">
                    ${result.score}/${result.max_score}
                </div>
                <p style="font-size: 1.2em; margin-bottom: 10px;">您的得分：${result.score} 分（${result.percentage}%）</p>
            `;
            
            document.getElementById('level-display').innerHTML = `
                <div class="level-badge" style="background: ${result.level_color}">
                    ${result.level}
                </div>
            `;
            
            const coursesHtml = result.recommended_courses.map((course, index) => `
                <div class="course-card">
                    <div class="course-number">${index + 1}.</div>
                    <div class="course-content">
                        <div class="course-title">${course.title}</div>
                        <div class="course-meta">
                            <span class="course-category">${course.category}</span>
                            <span class="course-level">${course.level}</span>
                        </div>
                        <div class="course-description">${course.description}</div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('courses-display').innerHTML = `
                <div class="courses">
                    <h3>🎯 根據您的答題表現，我們為您推薦以下課程：</h3>
                    <div class="course-summary">
                        <p>📊 您的分數：${result.score}/${result.max_score} (${result.percentage}%)</p>
                        <p>📈 技能等級：<span style="color: ${result.level_color}; font-weight: bold;">${result.level}</span></p>
                        <p>📚 推薦課程數量：${result.recommended_courses.length} 個</p>
                    </div>
                    ${coursesHtml}
                </div>
            `;
        }

        // 重新開始
        function restartQuiz() {
            currentQuestion = 0;
            answers = [];
            showHome();
        }

        // 管理員登錄
        async function adminLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;
            
            if (!username || !password) {
                alert('請輸入用戶名和密碼');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showPage('admin-panel');
                    loadAdminStats();
                } else {
                    alert('登錄失敗：' + (result.message || '用戶名或密碼錯誤'));
                }
            } catch (error) {
                console.error('登錄失敗:', error);
                alert('登錄失敗，請重試');
            }
        }

        // 管理員登出
        async function adminLogout() {
            try {
                await fetch('/api/admin/logout', { method: 'POST' });
                showHome();
            } catch (error) {
                console.error('登出失敗:', error);
            }
        }
        
        // ==================== 即時查看回應功能 ====================
        
        // 載入即時統計數據
        async function loadRealTimeStats() {
            try {
                const response = await fetch('/api/admin/real_time_stats');
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('real-time-stats-content').innerHTML = `
                        <p style="text-align: center; color: #dc3545; padding: 40px;">${data.error}</p>
                    `;
                    return;
                }
                
                // 顯示總回應數
                let html = `
                    <h2 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">總回應數：${data.total_responses}</h2>
                `;
                
                // 顯示問題統計 - 按照用戶要求的格式（不顯示正確答案標示）
                data.question_stats.forEach(q => {
                    // 只為前17題技術評估題顯示答對率
                    if (q.order <= 17) {
                        html += `
                            <div class="question-detail" style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3 style="font-size: 1.3em; margin-bottom: 10px; color: #333;">第${q.order}題: ${q.content}</h3>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">答對率${q.correct_rate}%</div>
                                <div style="font-size: 1.1em; margin-bottom: 10px; color: #666;">答對人數: ${q.correct_answers} / ${q.total_answers}</div>
                                <div style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">選項選擇統計</div>
                        `;
                        
                        // 為每個選項生成統計（不顯示正確答案標示）
                        q.option_stats.forEach((option, index) => {
                            html += `
                                <div style="
                                    padding: 5px 0; 
                                    font-size: 1.05em;
                                    color: #333;
                                ">
                                    ${index + 1}. ${option.option} ${option.percentage}% (${option.count})
                                </div>
                            `;
                        });
                        
                        html += `
                            </div>
                        `;
                    } else {
                        // 第18-19題興趣調查題的統計
                        html += `
                            <div class="question-detail" style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3 style="font-size: 1.3em; margin-bottom: 10px; color: #333;">第${q.order}題: ${q.content}</h3>
                                <div style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">選項選擇統計</div>
                        `;
                        
                        q.option_stats.forEach((option, index) => {
                            html += `
                                <div style="
                                    padding: 5px 0; 
                                    font-size: 1.05em;
                                    color: #333;
                                ">
                                    ${index + 1}. ${option.option} ${option.percentage}% (${option.count})
                                </div>
                            `;
                        });
                        
                        html += `
                            </div>
                        `;
                    }
                });
                
                document.getElementById('real-time-stats-content').innerHTML = html;
                
            } catch (error) {
                console.error('載入即時統計失敗:', error);
                document.getElementById('real-time-stats-content').innerHTML = `
                    <p style="text-align: center; color: #dc3545; padding: 40px;">載入失敗，請重試</p>
                `;
            }
        }
        
        // 刷新即時統計數據
        function refreshRealTimeStats() {
            document.getElementById('real-time-stats-content').innerHTML = `
                <p style="text-align: center; color: #666; padding: 40px;">載入中...</p>
            `;
            loadRealTimeStats();
        }
        
        // 當切換到即時查看回應頁面時自動載入數據
        function showAdminSection(section) {
            // 更新菜單狀態
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // 找到被點擊的菜單項並設為活躍狀態
            const clickedItem = document.querySelector(`[onclick="showAdminSection('${section}')"]`);
            if (clickedItem) {
                clickedItem.classList.add('active');
            }
            
            // 顯示對應內容
            document.querySelectorAll('.admin-content').forEach(content => {
                content.style.display = 'none';
            });
            
            const targetSection = document.getElementById(section);
            if (targetSection) {
                targetSection.style.display = 'block';
            }
            
            // 載入對應數據
            if (section === 'dashboard') {
                loadAdminStats();
            } else if (section === 'detailed-stats') {
                loadDetailedStats();
            } else if (section === 'responses') {
                loadRealTimeStats();
            } else if (section === 'questions') {
                loadAdminQuestions();
            } else if (section === 'courses') {
                showCoursesListView(); // 默認顯示課程總覽
            } else if (section === 'score-settings') {
                loadScoreSettings();
            } else if (section === 'users') {
                loadAdminProfile();
            } else if (section === 'export') {
                // 數據導出頁面不需要特殊載入
            }
        }

        // 載入管理員統計
        async function loadAdminStats() {
            try {
                const response = await fetch('/api/admin/stats');
                const data = await response.json();
                
                document.getElementById('stats-overview').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${data.total_responses}</div>
                        <div class="stat-label">總回應數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.total_questions}</div>
                        <div class="stat-label">問題總數</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${data.avg_score}</div>
                        <div class="stat-label">平均分數</div>
                    </div>
                `;
            } catch (error) {
                console.error('載入統計失敗:', error);
            }
        }

        // 載入詳細統計
        async function loadDetailedStats() {
            try {
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;
                
                let url = '/api/admin/detailed_stats';
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url);
                const data = await response.json();
                
                // 顯示總回應數
                document.getElementById('total-responses').innerHTML = `
                    <h2 style="font-size: 1.8em; margin-bottom: 20px; color: #333;">總回應數：${data.total_responses}</h2>
                `;
                
                // 顯示問題統計 - 按照用戶要求的精確格式
                let questionStatsHtml = '';
                data.question_stats.forEach(q => {
                    // 只為前17題技術評估題顯示答對率
                    if (q.order <= 17) {
                        questionStatsHtml += `
                            <div class="question-detail" style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3 style="font-size: 1.3em; margin-bottom: 10px; color: #333;">第${q.order}題: ${q.content}</h3>
                                <div style="font-size: 1.1em; margin-bottom: 5px;">答對率${q.correct_rate}%</div>
                                <div style="font-size: 1.1em; margin-bottom: 10px; color: #666;">答對人數: ${q.correct_answers} / ${q.total_answers}</div>
                                <div style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">選項選擇統計</div>
                        `;
                        
                        // 為每個選項生成統計，按照用戶要求的精確格式
                        q.option_stats.forEach((option, index) => {
                            const isCorrect = index === (q.correct_answer || 0);
                            const correctMark = isCorrect ? ' ✅' : '';
                            
                            questionStatsHtml += `
                                <div style="
                                    padding: 5px 0; 
                                    font-size: 1.05em;
                                    color: #333;
                                ">
                                    ${index + 1}. ${option.option}${correctMark} ${option.percentage}% (${option.count})
                                </div>
                            `;
                        });
                        
                        questionStatsHtml += `
                            </div>
                        `;
                    } else {
                        // 第18-19題興趣調查題的統計
                        questionStatsHtml += `
                            <div class="question-detail" style="margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                <h3 style="font-size: 1.3em; margin-bottom: 10px; color: #333;">第${q.order}題: ${q.content}</h3>
                                <div style="font-size: 1.1em; margin-bottom: 10px; font-weight: 600;">選項選擇統計</div>
                        `;
                        
                        q.option_stats.forEach((option, index) => {
                            questionStatsHtml += `
                                <div style="
                                    padding: 5px 0; 
                                    font-size: 1.05em;
                                    color: #333;
                                ">
                                    ${index + 1}. ${option.option} ${option.percentage}% (${option.count})
                                </div>
                            `;
                        });
                        
                        questionStatsHtml += `
                            </div>
                        `;
                    }
                });
                
                document.getElementById('question-stats').innerHTML = questionStatsHtml;
                
                // 顯示分數分布
                let scoreDistributionHtml = '<h3 style="font-size: 1.4em; margin-bottom: 20px; color: #333;">分數分布統計（0-17分）</h3>';
                scoreDistributionHtml += '<div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">';
                
                data.score_distribution.forEach(score => {
                    const barHeight = Math.max(score.percentage * 3, 10); // 最小高度10px
                    scoreDistributionHtml += `
                        <div style="
                            display: flex; 
                            flex-direction: column; 
                            align-items: center; 
                            margin: 5px;
                            min-width: 40px;
                        ">
                            <div style="
                                width: 30px; 
                                height: ${barHeight}px; 
                                background-color: #4CAF50; 
                                border-radius: 3px;
                                margin-bottom: 5px;
                            "></div>
                            <div style="font-size: 0.9em; font-weight: 600;">${score.score}分</div>
                            <div style="font-size: 0.8em; color: #666; text-align: center;">
                                ${score.percentage}%<br>(${score.count})
                            </div>
                        </div>
                    `;
                });
                
                scoreDistributionHtml += '</div>';
                
                document.getElementById('score-distribution').innerHTML = `
                    <div class="score-distribution" style="margin-top: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px;">
                        ${scoreDistributionHtml}
                    </div>
                `;
                
            } catch (error) {
                console.error('載入詳細統計失敗:', error);
            }
        }

        // 篩選數據
        function filterData() {
            loadDetailedStats();
        }

        // 清除篩選
        function clearFilter() {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            loadDetailedStats();
        }

        // 按日期清除數據
        async function clearDataByDate() {
            const startDate = document.getElementById('clear-start-date').value;
            const endDate = document.getElementById('clear-end-date').value;
            
            if (!startDate && !endDate) {
                alert('請選擇要清除的日期範圍');
                return;
            }
            
            if (!confirm('確定要清除選定日期範圍的數據嗎？此操作無法撤銷。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('數據清除成功');
                    loadDetailedStats();
                    loadAdminStats();
                } else {
                    alert('數據清除失敗');
                }
            } catch (error) {
                console.error('清除數據失敗:', error);
                alert('清除數據失敗，請重試');
            }
        }

        // 清除所有數據
        async function clearAllData() {
            if (!confirm('確定要清除所有數據嗎？此操作無法撤銷。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clear_all: true
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('所有數據清除成功');
                    loadDetailedStats();
                    loadAdminStats();
                } else {
                    alert('數據清除失敗');
                }
            } catch (error) {
                console.error('清除數據失敗:', error);
                alert('清除數據失敗，請重試');
            }
        }

        // ==================== 問題管理功能 ====================
        
        let currentEditingQuestion = null;
        
        // 載入問題列表（管理員用）
        async function loadAdminQuestions() {
            try {
                const response = await fetch('/api/admin/questions');
                const questionsData = await response.json();
                
                const container = document.getElementById('questions-list');
                container.innerHTML = questionsData.map(q => `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 10px;">第${q.order}題: ${q.content}</h4>
                                <p style="color: #666; margin-bottom: 10px;">類型: ${q.question_type === 'single' ? '單選題' : '多選題'}</p>
                                <div style="margin-bottom: 10px;">
                                    ${q.options.map((option, index) => `
                                        <div style="margin-bottom: 5px;">
                                            ${index + 1}. ${option} ${q.correct_answer === index || (Array.isArray(q.correct_answer) && q.correct_answer.includes(index)) ? '✅' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div style="margin-left: 20px;">
                                <button onclick="editQuestion(${q.id})" style="margin-right: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px;">編輯</button>
                                <button onclick="deleteQuestion(${q.id})" style="padding: 5px 15px; background: #f44336; color: white; border: none; border-radius: 5px;">刪除</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                alert('載入問題失敗');
            }
        }
        
        // 顯示添加問題模態框
        function showAddQuestionModal() {
            currentEditingQuestion = null;
            document.getElementById('question-modal-title').textContent = '添加新問題';
            document.getElementById('question-content').value = '';
            document.getElementById('question-type').value = 'single';
            
            // 清空選項
            const optionsContainer = document.getElementById('question-options');
            optionsContainer.innerHTML = '';
            
            // 添加默認選項
            for (let i = 0; i < 4; i++) {
                addQuestionOption();
            }
            
            updateCorrectAnswerSection();
            document.getElementById('question-modal').style.display = 'block';
        }
        
        // 編輯問題
        async function editQuestion(questionId) {
            try {
                const response = await fetch('/api/admin/questions');
                const questions = await response.json();
                const question = questions.find(q => q.id === questionId);
                
                if (!question) return;
                
                currentEditingQuestion = question;
                document.getElementById('question-modal-title').textContent = '編輯問題';
                document.getElementById('question-content').value = question.content;
                document.getElementById('question-type').value = question.question_type;
                
                // 載入選項
                const optionsContainer = document.getElementById('question-options');
                optionsContainer.innerHTML = '';
                
                question.options.forEach(option => {
                    addQuestionOption(option);
                });
                
                updateCorrectAnswerSection();
                
                // 設置正確答案
                if (question.question_type === 'single') {
                    if (question.correct_answer !== null && question.correct_answer !== undefined) {
                        const radio = document.querySelector(`input[name="correct-answer"][value="${question.correct_answer}"]`);
                        if (radio) radio.checked = true;
                    }
                } else {
                    if (question.correct_answer && Array.isArray(question.correct_answer)) {
                        question.correct_answer.forEach(index => {
                            const checkbox = document.querySelector(`input[name="correct-answer"][value="${index}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                }
                
                document.getElementById('question-modal').style.display = 'block';
            } catch (error) {
                alert('載入問題失敗');
            }
        }
        
        // 添加問題選項
        function addQuestionOption(value = '') {
            const optionsContainer = document.getElementById('question-options');
            const index = optionsContainer.children.length;
            
            const optionDiv = document.createElement('div');
            optionDiv.style.cssText = 'display: flex; margin-bottom: 10px; align-items: center;';
            optionDiv.innerHTML = `
                <span style="margin-right: 10px; width: 30px;">${index + 1}.</span>
                <input type="text" value="${value}" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; margin-right: 10px;">
                <button type="button" onclick="removeQuestionOption(this)" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 5px;">刪除</button>
            `;
            
            optionsContainer.appendChild(optionDiv);
            updateCorrectAnswerSection();
        }
        
        // 移除問題選項
        function removeQuestionOption(button) {
            button.parentElement.remove();
            updateCorrectAnswerSection();
            
            // 重新編號
            const optionsContainer = document.getElementById('question-options');
            Array.from(optionsContainer.children).forEach((div, index) => {
                div.querySelector('span').textContent = `${index + 1}.`;
            });
        }
        
        // 更新正確答案選擇區域
        function updateCorrectAnswerSection() {
            const questionType = document.getElementById('question-type').value;
            const optionsContainer = document.getElementById('question-options');
            const correctAnswerSection = document.getElementById('correct-answer-section');
            
            const options = Array.from(optionsContainer.children);
            
            if (questionType === 'single') {
                correctAnswerSection.innerHTML = options.map((_, index) => `
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="radio" name="correct-answer" value="${index}" style="margin-right: 10px;">
                        選項 ${index + 1}
                    </label>
                `).join('');
            } else {
                correctAnswerSection.innerHTML = options.map((_, index) => `
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" name="correct-answer" value="${index}" style="margin-right: 10px;">
                        選項 ${index + 1}
                    </label>
                `).join('');
            }
        }
        
        // 監聽問題類型變化
        document.addEventListener('DOMContentLoaded', function() {
            const questionTypeSelect = document.getElementById('question-type');
            if (questionTypeSelect) {
                questionTypeSelect.addEventListener('change', updateCorrectAnswerSection);
            }
        });
        
        // 保存問題
        async function saveQuestion() {
            const content = document.getElementById('question-content').value.trim();
            const questionType = document.getElementById('question-type').value;
            
            if (!content) {
                alert('請輸入問題內容');
                return;
            }
            
            // 獲取選項
            const optionsContainer = document.getElementById('question-options');
            const options = Array.from(optionsContainer.children).map(div => 
                div.querySelector('input[type="text"]').value.trim()
            ).filter(option => option);
            
            if (options.length < 2) {
                alert('至少需要2個選項');
                return;
            }
            
            // 獲取正確答案
            let correctAnswer;
            if (questionType === 'single') {
                const checkedRadio = document.querySelector('input[name="correct-answer"]:checked');
                if (!checkedRadio) {
                    alert('請選擇正確答案');
                    return;
                }
                correctAnswer = parseInt(checkedRadio.value);
            } else {
                const checkedCheckboxes = document.querySelectorAll('input[name="correct-answer"]:checked');
                if (checkedCheckboxes.length === 0) {
                    alert('請選擇至少一個正確答案');
                    return;
                }
                correctAnswer = Array.from(checkedCheckboxes).map(cb => parseInt(cb.value));
            }
            
            const questionData = {
                content,
                question_type: questionType,
                options,
                correct_answer: correctAnswer
            };
            
            try {
                let response;
                if (currentEditingQuestion) {
                    response = await fetch(`/api/admin/questions/${currentEditingQuestion.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                } else {
                    response = await fetch('/api/admin/questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                }
                
                if (response.ok) {
                    closeQuestionModal();
                    loadQuestions();
                    alert(currentEditingQuestion ? '問題更新成功' : '問題添加成功');
                } else {
                    alert('保存失敗，請重試');
                }
            } catch (error) {
                alert('保存失敗，請重試');
            }
        }
        
        // 刪除問題
        async function deleteQuestion(questionId) {
            if (!confirm('確定要刪除這個問題嗎？這將同時刪除相關的回應數據。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/questions/${questionId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadQuestions();
                    alert('問題刪除成功');
                } else {
                    alert('刪除失敗，請重試');
                }
            } catch (error) {
                alert('刪除失敗，請重試');
            }
        }
        
        // 關閉問題模態框
        function closeQuestionModal() {
            document.getElementById('question-modal').style.display = 'none';
        }
        
        // ==================== 課程管理功能 ====================
        
        let currentEditingCourse = null;
        
        // 載入課程列表
        async function loadCourses() {
            try {
                const response = await fetch('/api/admin/courses');
                const courses = await response.json();
                
                const container = document.getElementById('courses-list');
                container.innerHTML = courses.map(c => `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${c.is_active ? '#667eea' : '#ccc'}; ${!c.is_active ? 'opacity: 0.6;' : ''}">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${c.title}</h4>
                                    <span style="background: ${c.is_active ? '#4caf50' : '#f44336'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${c.is_active ? '開啟' : '關閉'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 10px;">${c.description}</p>
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.category}</span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.level}</span>
                                </div>
                                ${c.interest_tags && c.interest_tags.length > 0 ? `
                                    <div style="margin-top: 8px;">
                                        <small style="color: #666;">興趣關聯: </small>
                                        ${c.interest_tags.slice(0, 3).map(tag => `<span style="background: #fff3e0; color: #f57c00; padding: 2px 6px; border-radius: 8px; font-size: 0.8em; margin-right: 5px;">${tag}</span>`).join('')}
                                        ${c.interest_tags.length > 3 ? `<span style="color: #666; font-size: 0.8em;">等${c.interest_tags.length}項</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="margin-left: 20px;">
                                <button onclick="editCourse(${c.id})" style="margin-right: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px;">編輯</button>
                                <button onclick="deleteCourse(${c.id})" style="padding: 5px 15px; background: #f44336; color: white; border: none; border-radius: 5px;">刪除</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                alert('載入課程失敗');
            }
        }
        
        // 顯示添加課程模態框
        function showAddCourseModal() {
            currentEditingCourse = null;
            document.getElementById('course-modal-title').textContent = '添加新課程';
            document.getElementById('course-title').value = '';
            document.getElementById('course-description').value = '';
            document.getElementById('course-category').value = '新手入門';
            document.getElementById('course-level').value = '攝影新手';
            document.getElementById('course-active').checked = true;
            
            // 初始化興趣標籤選項
            initializeInterestTags();
            
            document.getElementById('course-modal').style.display = 'block';
        }
        
        // 初始化興趣標籤選項
        function initializeInterestTags(selectedTags = []) {
            const interestOptions = [
                '基本攝影知識 (光圈，快門，ISO，曝光補償)',
                '基本相機操作教學',
                '高階相機操作教學 (自訂功能設定)',
                '人物攝影（個人 / 家庭/ 小孩）',
                '人物攝影（情侶）',
                '人像攝影（模特兒）',
                '風景攝影 (風光)',
                '風景攝影 (旅行打卡)',
                '風景攝影 (夜景)',
                '風景攝影 (北極光)',
                '風景攝影 (天文)',
                '城市攝影 (建築)',
                '縮時攝影 (Timelapse)',
                '生態攝影 (動物大遷徙)',
                '生態攝影 (鳥攝)',
                '生態攝影 (花)',
                '生態攝影 (昆蟲)',
                '舞台攝影 (演唱會/ 台上表演/ 粵劇)',
                '街拍攝影 (人民生活紀錄)',
                '活動攝影 (公司周年晚會/ 婚宴)',
                '商業攝影 (產品)',
                '寵物攝影（貓 / 狗 / 其他寵物）',
                '運動攝影',
                '汽車攝影 (交通工具如巴士/地鐵/ 電車)',
                '汽車攝影 (公路汽車 / 賽車)',
                '寵物攝影',
                '執相教學 (後製修圖)',
                '拍片知識 (拍攝短片)',
                '其它',
                // 預留空白位置供未來擴展
                '【預留】拍攝題材1',
                '【預留】拍攝題材2',
                '【預留】拍攝題材3',
                '【預留】拍攝題材4',
                '【預留】拍攝題材5'
            ];
            
            const container = document.getElementById('interest-tags-container');
            container.innerHTML = interestOptions.map(option => `
                <label style="display: block; margin-bottom: 8px; cursor: pointer; ${option.includes('【預留】') ? 'opacity: 0.6; font-style: italic;' : ''}">
                    <input type="checkbox" value="${option}" ${selectedTags.includes(option) ? 'checked' : ''} style="margin-right: 8px;">
                    <span style="font-size: 0.9em;">${option}</span>
                </label>
            `).join('');
        }
        
        // 編輯課程
        async function editCourse(courseId) {
            try {
                const response = await fetch('/api/admin/courses');
                const courses = await response.json();
                const course = courses.find(c => c.id === courseId);
                
                if (!course) return;
                
                currentEditingCourse = course;
                document.getElementById('course-modal-title').textContent = '編輯課程';
                document.getElementById('course-title').value = course.title;
                document.getElementById('course-description').value = course.description;
                document.getElementById('course-category').value = course.category;
                document.getElementById('course-level').value = course.level;
                document.getElementById('course-active').checked = course.is_active !== false;
                
                // 初始化興趣標籤選項，並設置已選中的標籤
                const selectedTags = course.interest_tags || [];
                initializeInterestTags(selectedTags);
                
                document.getElementById('course-modal').style.display = 'block';
            } catch (error) {
                alert('載入課程失敗');
            }
        }
        
        // 保存課程
        async function saveCourse() {
            const title = document.getElementById('course-title').value.trim();
            const description = document.getElementById('course-description').value.trim();
            const category = document.getElementById('course-category').value;
            const level = document.getElementById('course-level').value;
            const isActive = document.getElementById('course-active').checked;
            
            // 獲取選中的興趣標籤
            const selectedTags = Array.from(document.querySelectorAll('#interest-tags-container input[type="checkbox"]:checked'))
                .map(checkbox => checkbox.value);
            
            if (!title || !description) {
                alert('請填寫課程標題和描述');
                return;
            }
            
            const courseData = { 
                title, 
                description, 
                category, 
                level, 
                is_active: isActive,
                interest_tags: selectedTags
            };
            
            try {
                let response;
                if (currentEditingCourse) {
                    response = await fetch(`/api/admin/courses/${currentEditingCourse.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(courseData)
                    });
                } else {
                    response = await fetch('/api/admin/courses', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(courseData)
                    });
                }
                
                if (response.ok) {
                    closeCourseModal();
                    loadCourses();
                    alert(currentEditingCourse ? '課程更新成功' : '課程添加成功');
                } else {
                    alert('保存失敗，請重試');
                }
            } catch (error) {
                alert('保存失敗，請重試');
            }
        }
        
        // 刪除課程
        async function deleteCourse(courseId) {
            if (!confirm('確定要刪除這個課程嗎？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/courses/${courseId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadCourses();
                    alert('課程刪除成功');
                } else {
                    alert('刪除失敗，請重試');
                }
            } catch (error) {
                alert('刪除失敗，請重試');
            }
        }
        
        // ==================== 新的課程管理界面函數 ====================
        
        // 顯示課程總覽
        function showCoursesListView() {
            document.getElementById('courses-list-view').style.display = 'block';
            document.getElementById('edit-course-selection').style.display = 'none';
            document.getElementById('delete-course-selection').style.display = 'none';
            loadCourses();
        }
        
        // 顯示編輯課程選擇界面
        function showEditCourseSelection() {
            document.getElementById('courses-list-view').style.display = 'none';
            document.getElementById('edit-course-selection').style.display = 'block';
            document.getElementById('delete-course-selection').style.display = 'none';
            loadEditCoursesList();
        }
        
        // 顯示刪除課程選擇界面
        function showDeleteCourseSelection() {
            document.getElementById('courses-list-view').style.display = 'none';
            document.getElementById('edit-course-selection').style.display = 'none';
            document.getElementById('delete-course-selection').style.display = 'block';
            loadDeleteCoursesList();
        }
        
        // 載入可編輯課程列表
        async function loadEditCoursesList() {
            try {
                const response = await fetch('/api/admin/courses');
                const courses = await response.json();
                
                const container = document.getElementById('edit-courses-list');
                if (courses.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">暫無課程可編輯</p>';
                    return;
                }
                
                container.innerHTML = courses.map(c => `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #007bff; cursor: pointer; transition: all 0.3s ease;" 
                         onclick="editCourse(${c.id})" 
                         onmouseover="this.style.boxShadow='0 4px 12px rgba(0,123,255,0.15)'; this.style.transform='translateY(-2px)'"
                         onmouseout="this.style.boxShadow='none'; this.style.transform='translateY(0)'">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${c.title}</h4>
                                    <span style="background: ${c.is_active ? '#4caf50' : '#f44336'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${c.is_active ? '開啟' : '關閉'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 10px;">${c.description}</p>
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.category}</span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.level}</span>
                                </div>
                                ${c.interest_tags && c.interest_tags.length > 0 ? `
                                    <div style="margin-top: 8px;">
                                        <small style="color: #666;">興趣關聯: </small>
                                        ${c.interest_tags.slice(0, 3).map(tag => `<span style="background: #fff3e0; color: #f57c00; padding: 2px 6px; border-radius: 8px; font-size: 0.8em; margin-right: 5px;">${tag}</span>`).join('')}
                                        ${c.interest_tags.length > 3 ? `<span style="color: #666; font-size: 0.8em;">等${c.interest_tags.length}項</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="margin-left: 20px;">
                                <span style="color: #007bff; font-size: 1.2em;">✏️</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('edit-courses-list').innerHTML = '<p style="text-align: center; color: #f44336; padding: 40px;">載入課程失敗</p>';
            }
        }
        
        // 載入可刪除課程列表
        async function loadDeleteCoursesList() {
            try {
                const response = await fetch('/api/admin/courses');
                const courses = await response.json();
                
                const container = document.getElementById('delete-courses-list');
                if (courses.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">暫無課程可刪除</p>';
                    return;
                }
                
                container.innerHTML = courses.map(c => `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #dc3545;">
                        <div style="display: flex; justify-content: between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <h4 style="margin: 0;">${c.title}</h4>
                                    <span style="background: ${c.is_active ? '#4caf50' : '#f44336'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">
                                        ${c.is_active ? '開啟' : '關閉'}
                                    </span>
                                </div>
                                <p style="color: #666; margin-bottom: 10px;">${c.description}</p>
                                <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.category}</span>
                                    <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 12px; border-radius: 15px; font-size: 0.9em;">${c.level}</span>
                                </div>
                                ${c.interest_tags && c.interest_tags.length > 0 ? `
                                    <div style="margin-top: 8px;">
                                        <small style="color: #666;">興趣關聯: </small>
                                        ${c.interest_tags.slice(0, 3).map(tag => `<span style="background: #fff3e0; color: #f57c00; padding: 2px 6px; border-radius: 8px; font-size: 0.8em; margin-right: 5px;">${tag}</span>`).join('')}
                                        ${c.interest_tags.length > 3 ? `<span style="color: #666; font-size: 0.8em;">等${c.interest_tags.length}項</span>` : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="margin-left: 20px;">
                                <button onclick="deleteCourse(${c.id})" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s ease;"
                                        onmouseover="this.style.background='#c82333'"
                                        onmouseout="this.style.background='#dc3545'">
                                    🗑️ 刪除
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('delete-courses-list').innerHTML = '<p style="text-align: center; color: #f44336; padding: 40px;">載入課程失敗</p>';
            }
        }
        
        // 關閉課程模態框
        function closeCourseModal() {
            document.getElementById('course-modal').style.display = 'none';
        }
        
        // ==================== 用戶資料管理功能 ====================
        
        // 載入管理員資料
        async function loadAdminProfile() {
            try {
                const response = await fetch('/api/admin/profile');
                const profile = await response.json();
                
                document.getElementById('admin-profile-username').value = profile.username;
                
                const infoContainer = document.getElementById('admin-profile-info');
                infoContainer.innerHTML = `
                    <p><strong>用戶名：</strong> ${profile.username}</p>
                    <p><strong>創建時間：</strong> ${new Date(profile.created_at).toLocaleString('zh-TW')}</p>
                `;
            } catch (error) {
                alert('載入管理員資料失敗');
            }
        }
        
        // 更新管理員資料
        async function updateAdminProfile() {
            const username = document.getElementById('admin-profile-username').value.trim();
            const password = document.getElementById('admin-profile-password').value;
            const passwordConfirm = document.getElementById('admin-profile-password-confirm').value;
            
            if (!username) {
                alert('請輸入用戶名');
                return;
            }
            
            if (password && password !== passwordConfirm) {
                alert('兩次輸入的密碼不一致');
                return;
            }
            
            if (password && password.length < 6) {
                alert('密碼長度至少6位');
                return;
            }
            
            const profileData = { username };
            if (password) {
                profileData.password = password;
            }
            
            try {
                const response = await fetch('/api/admin/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profileData)
                });
                
                if (response.ok) {
                    document.getElementById('admin-profile-password').value = '';
                    document.getElementById('admin-profile-password-confirm').value = '';
                    loadAdminProfile();
                    alert('資料更新成功');
                } else {
                    const error = await response.json();
                    alert(error.error || '更新失敗，請重試');
                }
            } catch (error) {
                alert('更新失敗，請重試');
            }
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            showHome();
        });

        // ==================== 數據導出功能 ====================
        
        // 清除導出日期
        function clearExportDates() {
            document.getElementById('export-start-date').value = '';
            document.getElementById('export-end-date').value = '';
        }
        
        // 設置今天範圍
        function setTodayRange() {
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
            
            document.getElementById('export-start-date').value = formatDateTimeLocal(startOfDay);
            document.getElementById('export-end-date').value = formatDateTimeLocal(endOfDay);
        }
        
        // 設置本週範圍
        function setWeekRange() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const startOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() - dayOfWeek);
            const endOfWeek = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (6 - dayOfWeek), 23, 59, 59);
            
            document.getElementById('export-start-date').value = formatDateTimeLocal(startOfWeek);
            document.getElementById('export-end-date').value = formatDateTimeLocal(endOfWeek);
        }
        
        // 設置本月範圍
        function setMonthRange() {
            const today = new Date();
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);
            
            document.getElementById('export-start-date').value = formatDateTimeLocal(startOfMonth);
            document.getElementById('export-end-date').value = formatDateTimeLocal(endOfMonth);
        }
        
        // 格式化日期時間為本地格式
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }
        
        // 清除篩選範圍內的數據
        async function clearFilteredData() {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            if (!startDate && !endDate) {
                alert('請選擇要清除的日期範圍');
                return;
            }
            
            const dateRange = startDate && endDate ? 
                `${startDate} 至 ${endDate}` : 
                startDate ? `${startDate} 之後` : `${endDate} 之前`;
            
            if (!confirm(`確定要清除 ${dateRange} 的數據嗎？此操作無法撤銷。`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate || null,
                        end_date: endDate || null
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('數據清除成功');
                    loadDetailedStats();
                    loadAdminStats();
                } else {
                    alert('數據清除失敗');
                }
            } catch (error) {
                console.error('清除數據失敗:', error);
                alert('清除數據失敗，請重試');
            }
        }
        
        // 導出Excel
        async function exportExcel() {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            // 顯示載入狀態
            document.getElementById('excel-loading').style.display = 'inline';
            document.getElementById('excel-text').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/export/excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate || null,
                        end_date: endDate || null
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 創建下載鏈接
                    const link = document.createElement('a');
                    link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,' + result.data;
                    link.download = result.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('Excel文件導出成功！');
                } else {
                    alert('Excel導出失敗：' + result.error);
                }
            } catch (error) {
                console.error('Excel導出失敗:', error);
                alert('Excel導出失敗，請重試');
            } finally {
                // 恢復按鈕狀態
                document.getElementById('excel-loading').style.display = 'none';
                document.getElementById('excel-text').style.display = 'inline';
            }
        }
        
        // 導出PowerPoint
        async function exportPowerPoint() {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;
            
            // 顯示載入狀態
            document.getElementById('ppt-loading').style.display = 'inline';
            document.getElementById('ppt-text').style.display = 'none';
            
            try {
                const response = await fetch('/api/admin/export/powerpoint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate || null,
                        end_date: endDate || null
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // 創建下載鏈接
                    const link = document.createElement('a');
                    link.href = 'data:application/vnd.openxmlformats-officedocument.presentationml.presentation;base64,' + result.data;
                    link.download = result.filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('PowerPoint文件導出成功！');
                } else {
                    alert('PowerPoint導出失敗：' + result.error);
                }
            } catch (error) {
                console.error('PowerPoint導出失敗:', error);
                alert('PowerPoint導出失敗，請重試');
            } finally {
                // 恢復按鈕狀態
                document.getElementById('ppt-loading').style.display = 'none';
                document.getElementById('ppt-text').style.display = 'inline';
            }
        }
        
        // ==================== 評分設定功能 ====================
        
        // 載入評分設定
        async function loadScoreSettings() {
            try {
                const response = await fetch('/api/admin/score-settings', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('載入評分設定失敗');
                }
                
                const data = await response.json();
                displayScoreSettings(data.settings);
                
            } catch (error) {
                console.error('載入評分設定錯誤:', error);
                document.getElementById('score-settings-list').innerHTML = 
                    '<p style="text-align: center; color: #dc3545; padding: 40px;">載入評分設定失敗，請重試</p>';
            }
        }
        
        // 顯示評分設定列表
        function displayScoreSettings(settings) {
            const container = document.getElementById('score-settings-list');
            
            if (!settings || settings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">暫無評分設定</p>';
                return;
            }
            
            let html = `
                <div style="display: grid; gap: 15px;">
            `;
            
            settings.forEach(setting => {
                const statusClass = setting.is_active ? 'success' : 'secondary';
                const statusText = setting.is_active ? '啟用' : '停用';
                
                html += `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid ${setting.is_active ? '#28a745' : '#6c757d'};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h5 style="margin: 0; color: #333;">${setting.level_name}</h5>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="padding: 4px 12px; background: ${setting.is_active ? '#28a745' : '#6c757d'}; color: white; border-radius: 15px; font-size: 12px;">
                                    ${statusText}
                                </span>
                                <button onclick="editScoreSetting(${setting.id})" style="padding: 5px 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    編輯
                                </button>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>分數範圍：</strong>${setting.min_score} - ${setting.max_score} 分
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                排序：第 ${setting.order} 位
                            </div>
                        </div>
                        ${setting.description ? `<div style="margin-top: 10px; color: #666; font-size: 14px;">${setting.description}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 編輯評分設定
        async function editScoreSetting(settingId) {
            try {
                // 載入評分設定數據
                const response = await fetch('/api/admin/score-settings', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('載入評分設定失敗');
                }
                
                const data = await response.json();
                const setting = data.settings.find(s => s.id === settingId);
                
                if (!setting) {
                    alert('找不到指定的評分設定');
                    return;
                }
                
                // 填充模態框數據
                document.getElementById('score-setting-modal-title').textContent = '編輯評分設定';
                document.getElementById('score-setting-level-name').value = setting.level_name;
                document.getElementById('score-setting-min-score').value = setting.min_score;
                document.getElementById('score-setting-max-score').value = setting.max_score;
                document.getElementById('score-setting-description').value = setting.description || '';
                document.getElementById('score-setting-active').checked = setting.is_active;
                
                // 設置編輯狀態
                window.currentEditingScoreSetting = settingId;
                
                // 顯示模態框
                document.getElementById('score-setting-modal').style.display = 'block';
                
            } catch (error) {
                console.error('載入評分設定失敗:', error);
                alert('載入評分設定失敗，請重試');
            }
        }
        
        // 刷新評分設定
        function refreshScoreSettings() {
            loadScoreSettings();
        }
        
        // 保存評分設定
        async function saveScoreSetting() {
            try {
                const levelName = document.getElementById('score-setting-level-name').value.trim();
                const minScore = parseInt(document.getElementById('score-setting-min-score').value);
                const maxScore = parseInt(document.getElementById('score-setting-max-score').value);
                const description = document.getElementById('score-setting-description').value.trim();
                const isActive = document.getElementById('score-setting-active').checked;
                
                // 驗證輸入
                if (!levelName) {
                    alert('請輸入等級名稱');
                    return;
                }
                
                if (isNaN(minScore) || isNaN(maxScore)) {
                    alert('請輸入有效的分數範圍');
                    return;
                }
                
                if (minScore >= maxScore) {
                    alert('最低分數必須小於最高分數');
                    return;
                }
                
                if (minScore < 0 || maxScore > 100) {
                    alert('分數範圍必須在0-100之間');
                    return;
                }
                
                const settingData = {
                    level_name: levelName,
                    min_score: minScore,
                    max_score: maxScore,
                    description: description,
                    is_active: isActive
                };
                
                const settingId = window.currentEditingScoreSetting;
                const url = `/api/admin/score-settings/${settingId}`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '保存評分設定失敗');
                }
                
                alert('評分設定保存成功！');
                closeScoreSettingModal();
                loadScoreSettings(); // 重新載入列表
                
            } catch (error) {
                console.error('保存評分設定失敗:', error);
                alert('保存評分設定失敗：' + error.message);
            }
        }
        
        // 關閉評分設定模態框
        function closeScoreSettingModal() {
            document.getElementById('score-setting-modal').style.display = 'none';
            window.currentEditingScoreSetting = null;
        }
        
        // ==================== 推介課程數量設定功能 ====================
        
        // 顯示推介課程數量設定界面
        function showRecommendationSettings() {
            // 隱藏其他界面
            document.getElementById('courses-list-view').style.display = 'none';
            document.getElementById('edit-course-selection').style.display = 'none';
            document.getElementById('delete-course-selection').style.display = 'none';
            
            // 顯示推介設定界面
            document.getElementById('recommendation-settings').style.display = 'block';
            
            // 載入推介設定數據
            loadRecommendationSettings();
        }
        
        // 載入推介課程數量設定
        async function loadRecommendationSettings() {
            try {
                const response = await fetch('/api/admin/recommendation-settings');
                const settings = await response.json();
                
                // 顯示當前啟用設定
                const activeSettings = settings.filter(s => s.is_active);
                const currentSettingDiv = document.getElementById('current-recommendation-setting');
                
                if (activeSettings.length > 0) {
                    const activeSetting = activeSettings[0];
                    currentSettingDiv.innerHTML = `
                        <h5 style="margin: 0 0 10px 0; color: #155724;">✅ 當前啟用設定</h5>
                        <p style="margin: 0; font-size: 16px;"><strong>${activeSetting.setting_name}</strong></p>
                        <p style="margin: 5px 0 0 0; color: #666;">推薦課程數量：${activeSetting.min_courses} - ${activeSetting.max_courses} 個</p>
                        ${activeSetting.description ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">${activeSetting.description}</p>` : ''}
                    `;
                } else {
                    currentSettingDiv.innerHTML = `
                        <h5 style="margin: 0 0 10px 0; color: #721c24;">⚠️ 沒有啟用的設定</h5>
                        <p style="margin: 0; color: #666;">請選擇一個設定並啟用</p>
                    `;
                }
                
                // 顯示所有設定列表
                const settingsListDiv = document.getElementById('recommendation-settings-list');
                if (settings.length === 0) {
                    settingsListDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>尚未創建任何推薦設定</p>
                            <p>點擊「新增設定」按鈕開始創建</p>
                        </div>
                    `;
                } else {
                    settingsListDiv.innerHTML = `
                        <h5 style="margin-bottom: 15px; color: #333;">所有推薦設定</h5>
                        <div style="display: grid; gap: 15px;">
                            ${settings.map(setting => `
                                <div style="border: 1px solid ${setting.is_active ? '#c3e6cb' : '#dee2e6'}; border-radius: 8px; padding: 15px; background: ${setting.is_active ? '#f8fff9' : '#f8f9fa'};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                        <div>
                                            <h6 style="margin: 0; color: #333;">${setting.setting_name} ${setting.is_active ? '<span style="color: #28a745; font-size: 12px;">●</span>' : ''}</h6>
                                            <p style="margin: 5px 0; color: #666; font-size: 14px;">推薦 ${setting.min_courses} - ${setting.max_courses} 個課程</p>
                                            ${setting.description ? `<p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">${setting.description}</p>` : ''}
                                        </div>
                                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                                            ${!setting.is_active ? `<button onclick="activateRecommendationSetting(${setting.id})" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 12px;">啟用</button>` : ''}
                                            <button onclick="editRecommendationSetting(${setting.id})" style="padding: 4px 8px; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 12px;">編輯</button>
                                            ${setting.setting_name !== 'default' ? `<button onclick="deleteRecommendationSetting(${setting.id})" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 12px;">刪除</button>` : ''}
                                        </div>
                                    </div>
                                    <div style="font-size: 12px; color: #999;">
                                        創建時間：${new Date(setting.created_at).toLocaleString('zh-TW')}
                                        ${setting.updated_at !== setting.created_at ? ` | 更新時間：${new Date(setting.updated_at).toLocaleString('zh-TW')}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('載入推薦設定失敗:', error);
                alert('載入推薦設定失敗，請重試');
            }
        }
        
        // 顯示新增推薦設定模態框
        function showAddRecommendationSettingModal() {
            document.getElementById('recommendation-setting-modal-title').textContent = '新增推介課程數量設定';
            document.getElementById('recommendation-setting-name').value = '';
            document.getElementById('recommendation-min-courses').value = '3';
            document.getElementById('recommendation-max-courses').value = '8';
            document.getElementById('recommendation-setting-description').value = '';
            document.getElementById('recommendation-setting-active').checked = false;
            
            // 清除編輯狀態
            window.currentEditingRecommendationSetting = null;
            
            document.getElementById('recommendation-setting-modal').style.display = 'block';
        }
        
        // 編輯推薦設定
        async function editRecommendationSetting(settingId) {
            try {
                const response = await fetch('/api/admin/recommendation-settings');
                const settings = await response.json();
                const setting = settings.find(s => s.id === settingId);
                
                if (!setting) {
                    alert('找不到指定的設定');
                    return;
                }
                
                document.getElementById('recommendation-setting-modal-title').textContent = '編輯推介課程數量設定';
                document.getElementById('recommendation-setting-name').value = setting.setting_name;
                document.getElementById('recommendation-min-courses').value = setting.min_courses;
                document.getElementById('recommendation-max-courses').value = setting.max_courses;
                document.getElementById('recommendation-setting-description').value = setting.description || '';
                document.getElementById('recommendation-setting-active').checked = setting.is_active;
                
                // 設置編輯狀態
                window.currentEditingRecommendationSetting = settingId;
                
                document.getElementById('recommendation-setting-modal').style.display = 'block';
                
            } catch (error) {
                console.error('載入設定失敗:', error);
                alert('載入設定失敗，請重試');
            }
        }
        
        // 保存推薦設定
        async function saveRecommendationSetting() {
            try {
                const name = document.getElementById('recommendation-setting-name').value.trim();
                const minCourses = parseInt(document.getElementById('recommendation-min-courses').value);
                const maxCourses = parseInt(document.getElementById('recommendation-max-courses').value);
                const description = document.getElementById('recommendation-setting-description').value.trim();
                const isActive = document.getElementById('recommendation-setting-active').checked;
                
                // 驗證輸入
                if (!name) {
                    alert('請輸入設定名稱');
                    return;
                }
                
                if (isNaN(minCourses) || isNaN(maxCourses)) {
                    alert('請輸入有效的課程數量');
                    return;
                }
                
                if (minCourses < 0 || maxCourses > 100) {
                    alert('課程數量必須在0-100範圍內');
                    return;
                }
                
                if (minCourses > maxCourses) {
                    alert('最少課程數量不能大於最多課程數量');
                    return;
                }
                
                const data = {
                    setting_name: name,
                    min_courses: minCourses,
                    max_courses: maxCourses,
                    description: description,
                    is_active: isActive
                };
                
                let response;
                if (window.currentEditingRecommendationSetting) {
                    // 更新現有設定
                    response = await fetch(`/api/admin/recommendation-settings/${window.currentEditingRecommendationSetting}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                } else {
                    // 創建新設定
                    response = await fetch('/api/admin/recommendation-settings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    closeRecommendationSettingModal();
                    loadRecommendationSettings();
                } else {
                    alert(result.error || '保存失敗');
                }
                
            } catch (error) {
                console.error('保存設定失敗:', error);
                alert('保存設定失敗，請重試');
            }
        }
        
        // 啟用推薦設定
        async function activateRecommendationSetting(settingId) {
            try {
                const response = await fetch(`/api/admin/recommendation-settings/${settingId}/activate`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    loadRecommendationSettings();
                } else {
                    alert(result.error || '啟用失敗');
                }
                
            } catch (error) {
                console.error('啟用設定失敗:', error);
                alert('啟用設定失敗，請重試');
            }
        }
        
        // 刪除推薦設定
        async function deleteRecommendationSetting(settingId) {
            if (!confirm('確定要刪除這個推薦設定嗎？此操作無法撤銷。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/recommendation-settings/${settingId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    loadRecommendationSettings();
                } else {
                    alert(result.error || '刪除失敗');
                }
                
            } catch (error) {
                console.error('刪除設定失敗:', error);
                alert('刪除設定失敗，請重試');
            }
        }
        
        // 關閉推薦設定模態框
        function closeRecommendationSettingModal() {
            document.getElementById('recommendation-setting-modal').style.display = 'none';
            window.currentEditingRecommendationSetting = null;
        }
        
        // 頁面載入完成後的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化頁面
            console.log('頁面載入完成');
        });
        
    </script>
</body>
</html>
